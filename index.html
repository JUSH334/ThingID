<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThingID - DIDLab Blockchain IoT Identity</title>
    
    <!-- Ethers.js from CDN -->
    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .didlab-badge {
            display: inline-block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 10px;
        }

        .network-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .network-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .network-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .connection-status {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .wallet-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }

        .wallet-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-card {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab.active {
            background: white;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.25);
            color: #667eea;
        }

        .panel {
            display: none;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .panel.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1e293b;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 28px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.35);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .message.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .device-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
        }

        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .status-disconnected {
            background: #ef4444;
        }

        .code-block {
            background: #1e293b;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .stat-card h2 {
            font-size: 42px;
            margin-bottom: 8px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 14px;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîó ThingID <span class="didlab-badge">üåê DIDLab Network</span></h1>
            <p style="margin-top: 10px; color: #64748b;">
                Decentralized IoT Device Management on DIDLab Blockchain
            </p>
            
            <div class="network-info">
                <strong>üì° DIDLab Network Configuration</strong>
                <div class="network-grid">
                    <div class="network-card">
                        <div style="font-size: 11px; opacity: 0.8;">CONTRACT ADDRESS</div>
                        <div style="font-weight: 600; font-size: 11px; margin-top: 5px;">0x5A0d...CAC4</div>
                    </div>
                    <div class="network-card">
                        <div style="font-size: 11px; opacity: 0.8;">RPC ENDPOINT</div>
                        <div style="font-weight: 600; font-size: 13px; margin-top: 5px;">https://eth.didlab.org</div>
                    </div>
                    <div class="network-card">
                        <div style="font-size: 11px; opacity: 0.8;">CHAIN ID</div>
                        <div style="font-weight: 600; font-size: 13px; margin-top: 5px;">252501</div>
                    </div>
                    <div class="network-card">
                        <div style="font-size: 11px; opacity: 0.8;">NATIVE TOKEN</div>
                        <div style="font-weight: 600; font-size: 13px; margin-top: 5px;">TRUST (TT)</div>
                    </div>
                    <div class="network-card">
                        <div style="font-size: 11px; opacity: 0.8;">EXPLORER</div>
                        <div style="font-weight: 600; font-size: 13px; margin-top: 5px;">explorer.didlab.org</div>
                    </div>
                    <div class="network-card">
                        <div style="font-size: 11px; opacity: 0.8;">LATEST BLOCK</div>
                        <div style="font-weight: 600; font-size: 13px; margin-top: 5px;" id="latestBlock">Loading...</div>
                    </div>
                </div>
            </div>
            
            <div class="connection-status">
                <strong>üìã Connection Status:</strong>
                <div style="margin-top: 10px;">
                    <div><span class="status-dot" id="ethersStatus"></span> Ethers.js: <span id="ethersText">Loading...</span></div>
                    <div><span class="status-dot" id="metamaskStatus"></span> MetaMask: <span id="metamaskText">Checking...</span></div>
                    <div><span class="status-dot" id="didlabStatus"></span> DIDLab RPC: <span id="didlabText">Connecting...</span></div>
                    <div><span class="status-dot" id="contractStatus"></span> Smart Contract: <span id="contractText">Not Connected</span></div>
                </div>
            </div>
        </div>

        <div class="wallet-section">
            <h3>Wallet Connection</h3>
            <button class="btn" id="connectBtn" onclick="connectWallet()">
                Connect to DIDLab Network ü¶ä
            </button>
            
            <button class="btn btn-secondary" id="addNetworkBtn" onclick="addDIDLabNetwork()" style="margin-left: 10px; display: none;">
                Add DIDLab to MetaMask ‚ûï
            </button>
            
            <div class="wallet-info" id="walletInfo" style="display: none;">
                <div class="info-card">
                    <div style="font-size: 12px; color: #64748b;">ADDRESS</div>
                    <div style="font-weight: 600;" id="walletAddress">-</div>
                </div>
                <div class="info-card">
                    <div style="font-size: 12px; color: #64748b;">NETWORK</div>
                    <div style="font-weight: 600;" id="networkName">-</div>
                </div>
                <div class="info-card">
                    <div style="font-size: 12px; color: #64748b;">BALANCE</div>
                    <div style="font-weight: 600;" id="walletBalance">-</div>
                </div>
                <div class="info-card">
                    <div style="font-size: 12px; color: #64748b;">CHAIN ID</div>
                    <div style="font-weight: 600;" id="chainId">-</div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('register')">üìù Register Device</button>
            <button class="tab" onclick="switchTab('devices')">üìä My Devices</button>
            <button class="tab" onclick="switchTab('global')">üåç Global Activity</button>
            <button class="tab" onclick="switchTab('access')">üîê Access Control</button>
            <button class="tab" onclick="switchTab('stream')">üì° Live Stream</button>
            <button class="tab" onclick="switchTab('info')">‚ÑπÔ∏è DIDLab Info</button>
        </div>

        <!-- Register Panel -->
        <div id="register-panel" class="panel active">
            <h2>Register New IoT Device on Blockchain</h2>
            <div id="register-message"></div>
            
            <div class="form-group">
                <label>Device Name *</label>
                <input type="text" id="deviceName" placeholder="Temperature Sensor #1">
            </div>
            
            <div class="form-group">
                <label>Device Type *</label>
                <select id="deviceType">
                    <option value="sensor">Sensor</option>
                    <option value="actuator">Actuator</option>
                    <option value="gateway">Gateway</option>
                    <option value="controller">Controller</option>
                    <option value="camera">Camera</option>
                    <option value="tracker">Tracker</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Manufacturer *</label>
                <input type="text" id="manufacturer" placeholder="SensorCorp">
            </div>
            
            <div class="form-group">
                <label>Model *</label>
                <input type="text" id="model" placeholder="TempSense-2024">
            </div>
            
            <div class="form-group">
                <label>Serial Number</label>
                <input type="text" id="serialNumber" placeholder="SN-2024-00001">
            </div>
            
            <div class="form-group">
                <label>Location</label>
                <input type="text" id="location" placeholder="Building A - Floor 3">
            </div>
            
            <button class="btn" onclick="registerDevice()">
                Register Device on DIDLab Blockchain
            </button>
        </div>

        <!-- Devices Panel -->
        <div id="devices-panel" class="panel">
            <h2>My Devices on DIDLab Blockchain</h2>
            <div id="devices-message"></div>
            
            <button class="btn" onclick="loadMyDevices()">
                Refresh My Devices
            </button>
            
            <div id="devicesList" style="margin-top: 20px;">
                <p>No devices registered yet.</p>
            </div>
        </div>

        <!-- Global Activity Panel -->
        <div id="global-panel" class="panel">
            <h2>üåç Global Network Activity</h2>
            <div id="global-message"></div>
            
            <button class="btn" onclick="loadGlobalActivity()">
                Refresh Global Activity
            </button>
            
            <div id="globalStats" style="margin-top: 20px;">
                <div class="device-card">
                    <h3>üìä Network Statistics</h3>
                    <div id="statsContent" style="margin-top: 15px;">
                        <p>Click "Refresh Global Activity" to load stats...</p>
                    </div>
                </div>
                
                <div class="device-card">
                    <h3>üÜï Recent Device Registrations (All Users)</h3>
                    <div id="recentActivity" style="margin-top: 15px;">
                        <p>Loading recent registrations...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Access Panel -->
        <div id="access-panel" class="panel">
            <h2>Access Control Management</h2>
            <div id="access-message"></div>
            
            <h3>Grant Access Pass</h3>
            <div class="form-group">
                <label>Device</label>
                <select id="grantDeviceSelect">
                    <option value="">Select a device...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Grant To (Address)</label>
                <input type="text" id="grantToAddress" placeholder="0x...">
            </div>
            
            <div class="form-group">
                <label>Duration</label>
                <select id="grantDuration">
                    <option value="3600">1 Hour</option>
                    <option value="86400">1 Day</option>
                    <option value="604800">1 Week</option>
                    <option value="2592000">30 Days</option>
                </select>
            </div>
            
            <button class="btn" onclick="grantAccess()">
                Grant Access Pass
            </button>

            <hr style="margin: 30px 0;">
            
            <h3>My Access Passes</h3>
            <button class="btn" onclick="loadAccessPasses()">
                Load Access Passes
            </button>
            <div id="accessPassesList" style="margin-top: 20px;"></div>
        </div>

        <!-- Stream Panel -->
        <div id="stream-panel" class="panel">
            <h2>Live Device Stream</h2>
            <div id="stream-message"></div>
            
            <div class="form-group">
                <label>Select Device with Access</label>
                <select id="streamDeviceSelect">
                    <option value="">Select a device...</option>
                </select>
            </div>
            
            <button class="btn" onclick="startStream()">
                Start Streaming
            </button>
            <button class="btn" onclick="stopStream()" style="margin-left: 10px; background: #ef4444;">
                Stop Stream
            </button>
            
            <div id="streamData" style="margin-top: 20px;"></div>
        </div>

        <!-- Info Panel -->
        <div id="info-panel" class="panel">
            <h2>DIDLab Network Information</h2>
            
            <div class="device-card">
                <h3>üåê About DIDLab</h3>
                <p style="margin-top: 10px; line-height: 1.6;">
                    DIDLab is a production-grade Hyperledger Besu QBFT network designed for educational purposes, 
                    research, and consortium experiments. It provides a classroom environment for learning 
                    blockchain development with decentralized identity (DID) tools and verifiable credentials.
                </p>
            </div>

            <div class="device-card">
                <h3>üîß Network Configuration</h3>
                <div class="code-block">
Network Name: DIDLab QBFT<br>
RPC URL: https://eth.didlab.org<br>
Chain ID: 252501<br>
Currency Symbol: TT (TRUST)<br>
Block Explorer: https://explorer.didlab.org<br>
Faucet: https://faucet.didlab.org<br>
Contract: 0x5A0d15B2E16b67Bf8dCbd2DfBf147d4A20e5CAC4
                </div>
            </div>

            <div class="device-card">
                <h3>ü™ô Getting Test TRUST Tokens</h3>
                <p style="margin-top: 10px; line-height: 1.6;">
                    1. Visit the DIDLab Faucet: <a href="https://faucet.didlab.org" target="_blank" style="color: #667eea;">faucet.didlab.org</a><br>
                    2. Enter your wallet address<br>
                    3. Complete the captcha<br>
                    4. Receive 10 TrustTokens (TT) for gas fees
                </p>
            </div>

            <div class="device-card">
                <h3>üîç Block Explorer</h3>
                <p style="margin-top: 10px; line-height: 1.6;">
                    View transactions, blocks, and smart contracts on the DIDLab explorer:<br>
                    <a href="https://explorer.didlab.org" target="_blank" style="color: #667eea;">explorer.didlab.org</a>
                </p>
            </div>

            <div class="device-card">
                <h3>üìö Features</h3>
                <ul style="margin-top: 10px; line-height: 1.8; margin-left: 20px;">
                    <li>No real money required - educational blockchain</li>
                    <li>QBFT consensus mechanism</li>
                    <li>Support for DID (Decentralized Identifiers)</li>
                    <li>NFT and soulbound credentials</li>
                    <li>DIDLab Swap AMM for learning</li>
                    <li>Smart contract deployed and active</li>
                    <li>Global device registry visible to all</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // DIDLab Network Configuration
        const DIDLAB_CONFIG = {
            chainId: '252501', // 252501 in hex
            chainName: 'DIDLab QBFT',
            nativeCurrency: {
                name: 'TRUST',
                symbol: 'TT',
                decimals: 18
            },
            rpcUrls: ['https://eth.didlab.org'],
            blockExplorerUrls: ['https://explorer.didlab.org']
        };

        // Smart Contract Configuration
        const CONTRACT_ADDRESS = '0x5A0d15B2E16b67Bf8dCbd2DfBf147d4A20e5CAC4';
        const CONTRACT_ABI = [
            "function registerDevice(string _did, string _name, string _deviceType, string _manufacturer, string _model, string _serialNumber, string _location, string _publicKey) returns (bytes32)",
            "function getDevice(bytes32 deviceId) view returns (tuple(string did, string name, string deviceType, string manufacturer, string model, string serialNumber, string location, string publicKey, address owner, uint256 registeredAt, bool isActive))",
            "function getOwnerDevices(address owner) view returns (bytes32[])",
            "function getTotalDevices() view returns (uint256)",
            "function grantAccess(bytes32 deviceId, address viewer, uint256 duration)",
            "function hasAccess(bytes32 deviceId, address viewer) view returns (bool)",
            "function VERSION() view returns (string)",
            "function NETWORK() view returns (string)",
            "event DeviceRegistered(bytes32 indexed deviceId, string did, address indexed owner, string name, string deviceType, uint256 timestamp)"
        ];

        // Global variables
        let provider = null;
        let signer = null;
        let currentAccount = null;
        let contract = null;
        let devices = [];
        let accessPasses = [];
        let streamInterval = null;
        let didlabProvider = null;

        // Initialize on page load
        window.addEventListener('load', async () => {
            // Check Ethers.js
            if (typeof ethers !== 'undefined') {
                document.getElementById('ethersStatus').className = 'status-dot status-connected';
                document.getElementById('ethersText').textContent = 'Loaded ‚úì';
                console.log('‚úÖ Ethers.js loaded');
            } else {
                document.getElementById('ethersStatus').className = 'status-dot status-disconnected';
                document.getElementById('ethersText').textContent = 'Failed';
            }

            // Check MetaMask
            if (typeof window.ethereum !== 'undefined') {
                document.getElementById('metamaskStatus').className = 'status-dot status-connected';
                document.getElementById('metamaskText').textContent = 'Installed ‚úì';
            } else {
                document.getElementById('metamaskStatus').className = 'status-dot status-disconnected';
                document.getElementById('metamaskText').textContent = 'Not Installed';
            }

            // Connect to DIDLab RPC
            await connectToDIDLabRPC();
        });

        // Connect to DIDLab RPC
        async function connectToDIDLabRPC() {
            try {
                didlabProvider = new ethers.providers.JsonRpcProvider('https://eth.didlab.org');
                
                // Test connection
                const blockNumber = await didlabProvider.getBlockNumber();
                const network = await didlabProvider.getNetwork();
                
                document.getElementById('didlabStatus').className = 'status-dot status-connected';
                document.getElementById('didlabText').textContent = 'Connected ‚úì';
                document.getElementById('latestBlock').textContent = blockNumber.toLocaleString();
                
                console.log('‚úÖ Connected to DIDLab:', network);
                
                // Update block number every 15 seconds
                setInterval(async () => {
                    try {
                        const block = await didlabProvider.getBlockNumber();
                        document.getElementById('latestBlock').textContent = block.toLocaleString();
                    } catch (e) {
                        console.error('Failed to update block:', e);
                    }
                }, 15000);
                
            } catch (error) {
                document.getElementById('didlabStatus').className = 'status-dot status-disconnected';
                document.getElementById('didlabText').textContent = 'Connection Failed';
                console.error('‚ùå DIDLab connection error:', error);
            }
        }

        // Add DIDLab network to MetaMask
        async function addDIDLabNetwork() {
            try {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [DIDLAB_CONFIG]
                });
                
                showMessage('register-message', '‚úÖ DIDLab network added to MetaMask!', 'success');
                document.getElementById('addNetworkBtn').style.display = 'none';
                
                // Try connecting again
                setTimeout(() => connectWallet(), 1000);
            } catch (error) {
                console.error('Error adding network:', error);
                showMessage('register-message', '‚ùå Failed to add network: ' + error.message, 'error');
            }
        }

        // Connect wallet to DIDLab
        async function connectWallet() {
            try {
                if (typeof ethers === 'undefined') {
                    showMessage('register-message', '‚ùå Ethers.js not loaded', 'error');
                    return;
                }

                if (typeof window.ethereum === 'undefined') {
                    showMessage('register-message', 
                        '‚ùå MetaMask not installed! Install from metamask.io', 
                        'error'
                    );
                    return;
                }

                // Request account access
                provider = new ethers.providers.Web3Provider(window.ethereum);
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });

                if (accounts.length > 0) {
                    currentAccount = accounts[0];
                    signer = provider.getSigner();
                    
                    // Check if on DIDLab network
                    const network = await provider.getNetwork();
                    
                    if (network.chainId !== 252501) {
                        showMessage('register-message', 
                            '‚ö†Ô∏è Please switch to DIDLab network (Chain ID: 252501)', 
                            'error'
                        );
                        document.getElementById('addNetworkBtn').style.display = 'inline-block';
                        return;
                    }
                    
                    // Update UI
                    document.getElementById('walletInfo').style.display = 'grid';
                    document.getElementById('walletAddress').textContent = 
                        currentAccount.slice(0, 6) + '...' + currentAccount.slice(-4);
                    document.getElementById('networkName').textContent = 'DIDLab QBFT';
                    document.getElementById('chainId').textContent = '252501';
                    
                    // Get balance
                    const balance = await provider.getBalance(currentAccount);
                    document.getElementById('walletBalance').textContent = 
                        ethers.utils.formatEther(balance).slice(0, 6) + ' TT';
                    
                    // Initialize contract
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    console.log('‚úÖ Contract initialized:', CONTRACT_ADDRESS);
                    document.getElementById('contractStatus').className = 'status-dot status-connected';
                    document.getElementById('contractText').textContent = 'Connected ‚úì';
                    
                    document.getElementById('connectBtn').textContent = 'Connected to DIDLab ‚úì';
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('addNetworkBtn').style.display = 'none';
                    
                    showMessage('register-message', '‚úÖ Connected to DIDLab network and smart contract!', 'success');
                    loadMyDevices();
                }
            } catch (error) {
                console.error('‚ùå Connection error:', error);
                showMessage('register-message', '‚ùå Failed to connect: ' + error.message, 'error');
            }
        }

        // Register device on DIDLab Blockchain
        async function registerDevice() {
            if (!currentAccount) {
                showMessage('register-message', '‚ö†Ô∏è Please connect wallet first!', 'error');
                return;
            }

            if (!contract) {
                showMessage('register-message', '‚ö†Ô∏è Contract not initialized!', 'error');
                return;
            }

            const name = document.getElementById('deviceName').value;
            const type = document.getElementById('deviceType').value;
            const manufacturer = document.getElementById('manufacturer').value;
            const model = document.getElementById('model').value;
            const serialNumber = document.getElementById('serialNumber').value || 'N/A';
            const location = document.getElementById('location').value || 'Not specified';

            if (!name || !manufacturer || !model) {
                showMessage('register-message', '‚ö†Ô∏è Please fill required fields!', 'error');
                return;
            }

            try {
                showMessage('register-message', '‚è≥ Registering device on blockchain...', 'info');
                
                // Generate DID following DIDLab convention
                const timestamp = Date.now();
                const did = `did:didlab:device:${type}:${timestamp}`;
                
                // Generate public key (in production, this would be from device)
                const wallet = ethers.Wallet.createRandom();
                const pubKey = wallet.publicKey;

                // Call smart contract
                console.log('üìù Sending transaction to blockchain...');
                const tx = await contract.registerDevice(
                    did,
                    name,
                    type,
                    manufacturer,
                    model,
                    serialNumber,
                    location,
                    pubKey
                );

                showMessage('register-message', 
                    `‚è≥ Transaction sent! Hash: ${tx.hash}<br>Waiting for confirmation...`, 
                    'info'
                );

                // Wait for confirmation
                const receipt = await tx.wait();
                console.log('‚úÖ Transaction confirmed:', receipt);

                // Extract device ID from event
                const event = receipt.events?.find(e => e.event === 'DeviceRegistered');
                const deviceId = event ? event.args.deviceId : 'device-' + timestamp;

                const device = {
                    id: deviceId,
                    did,
                    name,
                    type,
                    manufacturer,
                    model,
                    serialNumber,
                    location,
                    owner: currentAccount,
                    pubKey,
                    timestamp: new Date().toISOString(),
                    status: 'active',
                    network: 'DIDLab QBFT',
                    txHash: tx.hash,
                    blockNumber: receipt.blockNumber
                };

                // Store locally for quick access
                devices.push(device);
                localStorage.setItem('thingid_devices_didlab_' + currentAccount, JSON.stringify(devices));

                showMessage('register-message', 
                    `‚úÖ Device "${name}" registered on DIDLab blockchain!<br>
                    DID: ${did}<br>
                    Tx: <a href="https://explorer.didlab.org/tx/${tx.hash}" target="_blank" style="color: #667eea;">View on Explorer</a>`, 
                    'success'
                );

                // Clear form
                document.getElementById('deviceName').value = '';
                document.getElementById('serialNumber').value = '';
                document.getElementById('location').value = '';
                
                loadMyDevices();
            } catch (error) {
                console.error('‚ùå Registration error:', error);
                
                if (error.code === 4001) {
                    showMessage('register-message', '‚ö†Ô∏è Transaction rejected by user', 'error');
                } else if (error.message.includes('insufficient funds')) {
                    showMessage('register-message', '‚ùå Insufficient TT tokens for gas', 'error');
                } else {
                    showMessage('register-message', '‚ùå Registration failed: ' + error.message, 'error');
                }
            }
        }

        // Load devices from blockchain
        async function loadMyDevices() {
            if (!currentAccount) {
                document.getElementById('devicesList').innerHTML = 
                    '<p>Please connect wallet to view devices.</p>';
                return;
            }

            try {
                if (contract) {
                    console.log('üìä Loading devices from blockchain...');
                    const deviceIds = await contract.getOwnerDevices(currentAccount);
                    
                    if (deviceIds.length > 0) {
                        showMessage('devices-message', '‚è≥ Loading devices from blockchain...', 'info');
                        
                        const blockchainDevices = await Promise.all(
                            deviceIds.map(async (id) => {
                                try {
                                    const device = await contract.getDevice(id);
                                    
                                    const saved = localStorage.getItem('thingid_devices_didlab_' + currentAccount);
                                    let txHash = null;
                                    if (saved) {
                                        const localDevices = JSON.parse(saved);
                                        const localDevice = localDevices.find(d => d.id === id);
                                        txHash = localDevice?.txHash;
                                    }
                                    
                                    return {
                                        id: id,
                                        did: device.did,
                                        name: device.name,
                                        type: device.deviceType,
                                        manufacturer: device.manufacturer,
                                        model: device.model,
                                        serialNumber: device.serialNumber,
                                        location: device.location,
                                        owner: device.owner,
                                        registeredAt: device.registeredAt.toNumber(),
                                        status: device.isActive ? 'active' : 'inactive',
                                        network: 'DIDLab QBFT (Blockchain)',
                                        txHash: txHash
                                    };
                                } catch (e) {
                                    console.error('Error loading device:', e);
                                    return null;
                                }
                            })
                        );
                        
                        devices = blockchainDevices.filter(d => d !== null);
                        localStorage.setItem('thingid_devices_didlab_' + currentAccount, JSON.stringify(devices));
                        
                        showMessage('devices-message', `‚úÖ Loaded ${devices.length} devices from blockchain`, 'success');
                    }
                }
            } catch (error) {
                console.error('Error loading from blockchain:', error);
                showMessage('devices-message', '‚ö†Ô∏è Loading from local storage...', 'info');
            }

            const saved = localStorage.getItem('thingid_devices_didlab_' + currentAccount);
            if (saved && devices.length === 0) {
                devices = JSON.parse(saved);
            }

            if (devices.length === 0) {
                document.getElementById('devicesList').innerHTML = 
                    '<p>No devices registered yet. Register your first device!</p>';
                return;
            }

            const html = devices.map(device => `
                <div class="device-card">
                    <h3>${device.name}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <p><strong>Type:</strong> ${device.type}</p>
                        <p><strong>Status:</strong> <span style="color: #10b981;">‚óè ${device.status}</span></p>
                        <p><strong>Manufacturer:</strong> ${device.manufacturer}</p>
                        <p><strong>Model:</strong> ${device.model}</p>
                        <p><strong>Serial:</strong> ${device.serialNumber}</p>
                        <p><strong>Location:</strong> ${device.location}</p>
                        <p><strong>Network:</strong> ${device.network}</p>
                    </div>
                    <div style="margin-top: 10px;">
                        <p><strong>DID:</strong></p>
                        <div class="code-block" style="font-size: 11px; margin-top: 5px;">${device.did}</div>
                    </div>
                    <p style="font-size: 12px; color: #64748b; margin-top: 10px;">
                        Registered: ${new Date(device.timestamp || device.registeredAt * 1000).toLocaleString()}
                    </p>
                    <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                        ${device.txHash ? `
                            <a href="https://explorer.didlab.org/tx/${device.txHash}" target="_blank" 
                               style="color: #667eea; text-decoration: none; font-size: 14px;">
                                üìä View Transaction ‚Üí
                            </a>
                        ` : ''}
                        <a href="https://explorer.didlab.org/address/${device.owner}" target="_blank" 
                           style="color: #10b981; text-decoration: none; font-size: 14px;">
                            üë§ View Owner ‚Üí
                        </a>
                        <a href="https://explorer.didlab.org/address/${CONTRACT_ADDRESS}" target="_blank" 
                           style="color: #f59e0b; text-decoration: none; font-size: 14px;">
                            üìú View Contract ‚Üí
                        </a>
                    </div>
                </div>
            `).join('');

            document.getElementById('devicesList').innerHTML = html;

            const options = '<option value="">Select a device...</option>' +
                devices.map(d => `<option value="${d.id}">${d.name} (${d.type})</option>`).join('');
            document.getElementById('grantDeviceSelect').innerHTML = options;
            document.getElementById('streamDeviceSelect').innerHTML = options;
        }

        // Load global activity
        async function loadGlobalActivity() {
            showMessage('global-message', '‚è≥ Loading global network data...', 'info');
            
            try {
                const readOnlyContract = new ethers.Contract(
                    CONTRACT_ADDRESS,
                    CONTRACT_ABI,
                    didlabProvider
                );
                
                const totalDevices = await readOnlyContract.getTotalDevices();
                const blockNumber = await didlabProvider.getBlockNumber();
                
                document.getElementById('statsContent').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">TOTAL DEVICES</div>
                            <div style="font-size: 42px; font-weight: 700;">${totalDevices}</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Registered Globally</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">NETWORK BLOCK</div>
                            <div style="font-size: 42px; font-weight: 700;">${blockNumber.toLocaleString()}</div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Current Height</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);">
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 8px;">SMART CONTRACT</div>
                            <div style="font-size: 16px; font-weight: 600; word-break: break-all; line-height: 1.4;">
                                ${CONTRACT_ADDRESS.slice(0,10)}...${CONTRACT_ADDRESS.slice(-8)}
                            </div>
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">ThingID v1.0.0</div>
                        </div>
                    </div>
                `;
                
                try {
                    const filter = readOnlyContract.filters.DeviceRegistered();
                    const events = await readOnlyContract.queryFilter(filter, -10000, 'latest');
                    
                    if (events.length > 0) {
                        const recentHTML = events.slice(-10).reverse().map(event => `
                            <div style="padding: 15px; background: #f8fafc; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #667eea;">
                                <div style="display: flex; justify-content: space-between; align-items: start; gap: 15px;">
                                    <div style="flex: 1;">
                                        <strong style="font-size: 16px;">${event.args.name}</strong>
                                        <div style="font-size: 13px; color: #64748b; margin-top: 5px;">
                                            Type: <strong>${event.args.deviceType}</strong> | 
                                            Owner: <strong>${event.args.owner.slice(0,6)}...${event.args.owner.slice(-4)}</strong>
                                        </div>
                                        <div style="font-size: 12px; color: #94a3b8; margin-top: 3px; word-break: break-all;">
                                            DID: ${event.args.did}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <a href="https://explorer.didlab.org/tx/${event.transactionHash}" target="_blank" 
                                           style="color: #667eea; text-decoration: none; font-size: 13px; font-weight: 600;">
                                            View Tx ‚Üí
                                        </a>
                                        <div style="font-size: 11px; color: #94a3b8; margin-top: 5px;">
                                            Block ${event.blockNumber}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                        
                        document.getElementById('recentActivity').innerHTML = recentHTML;
                    } else {
                        document.getElementById('recentActivity').innerHTML = '<p style="color: #64748b;">No registrations found yet. Be the first to register a device!</p>';
                    }
                } catch (e) {
                    console.error('Error loading events:', e);
                    document.getElementById('recentActivity').innerHTML = '<p style="color: #f59e0b;">‚ö†Ô∏è Event history not available. The contract may need more activity.</p>';
                }
                
                showMessage('global-message', '‚úÖ Global activity loaded successfully', 'success');
                
            } catch (error) {
                console.error('Error loading global activity:', error);
                showMessage('global-message', '‚ùå Failed to load: ' + error.message, 'error');
                document.getElementById('statsContent').innerHTML = '<p style="color: #ef4444;">Error loading stats. Please try again.</p>';
            }
        }

        // Grant access
        function grantAccess() {
            if (!currentAccount) {
                showMessage('access-message', '‚ö†Ô∏è Please connect wallet first!', 'error');
                return;
            }

            const deviceId = document.getElementById('grantDeviceSelect').value;
            const toAddress = document.getElementById('grantToAddress').value;
            const duration = document.getElementById('grantDuration').value;

            if (!deviceId || !toAddress) {
                showMessage('access-message', '‚ö†Ô∏è Please fill all fields!', 'error');
                return;
            }

            if (!ethers.utils.isAddress(toAddress)) {
                showMessage('access-message', '‚ö†Ô∏è Invalid Ethereum address!', 'error');
                return;
            }

            const device = devices.find(d => d.id === deviceId);
            const pass = {
                id: 'pass-' + Date.now(),
                deviceId,
                deviceName: device.name,
                deviceDid: device.did,
                viewer: toAddress,
                grantedBy: currentAccount,
                grantedAt: Date.now(),
                expiresAt: Date.now() + (parseInt(duration) * 1000),
                network: 'DIDLab'
            };

            accessPasses.push(pass);
            localStorage.setItem('thingid_passes_didlab_' + currentAccount, JSON.stringify(accessPasses));

            showMessage('access-message', 
                `‚úÖ Access granted on DIDLab to ${toAddress.slice(0, 6)}...${toAddress.slice(-4)}`, 
                'success'
            );

            document.getElementById('grantToAddress').value = '';
        }

        // Load access passes
        function loadAccessPasses() {
            if (!currentAccount) {
                showMessage('access-message', '‚ö†Ô∏è Please connect wallet first!', 'error');
                return;
            }

            const saved = localStorage.getItem('thingid_passes_didlab_' + currentAccount);
            if (saved) {
                accessPasses = JSON.parse(saved);
            }

            if (accessPasses.length === 0) {
                document.getElementById('accessPassesList').innerHTML = 
                    '<p style="margin-top: 15px;">No access passes granted yet.</p>';
                return;
            }

            const html = accessPasses.map(pass => {
                const isExpired = pass.expiresAt < Date.now();
                const expiresIn = Math.floor((pass.expiresAt - Date.now()) / 1000);
                
                return `
                    <div class="device-card">
                        <h4>${pass.deviceName}</h4>
                        <p><strong>Viewer:</strong> ${pass.viewer.slice(0, 8)}...${pass.viewer.slice(-6)}</p>
                        <p><strong>Network:</strong> ${pass.network}</p>
                        <p><strong>Status:</strong> 
                            <span style="color: ${isExpired ? '#ef4444' : '#10b981'};">
                                ${isExpired ? '‚óè Expired' : `‚óè Active (${Math.floor(expiresIn / 60)} min left)`}
                            </span>
                        </p>
                        <p style="font-size: 12px; color: #64748b;">
                            Granted: ${new Date(pass.grantedAt).toLocaleString()}
                        </p>
                    </div>
                `;
            }).join('');

            document.getElementById('accessPassesList').innerHTML = html;
        }

        // Start stream
        function startStream() {
            if (!currentAccount) {
                showMessage('stream-message', '‚ö†Ô∏è Please connect wallet first!', 'error');
                return;
            }

            const deviceId = document.getElementById('streamDeviceSelect').value;
            if (!deviceId) {
                showMessage('stream-message', '‚ö†Ô∏è Please select a device!', 'error');
                return;
            }

            const device = devices.find(d => d.id === deviceId);
            
            showMessage('stream-message', `üì° Streaming data from ${device.name} on DIDLab...`, 'info');
            
            if (streamInterval) {
                clearInterval(streamInterval);
            }

            streamInterval = setInterval(() => {
                const data = generateMockStreamData(device);
                displayStreamData(data);
            }, 2000);
        }

        // Stop stream
        function stopStream() {
            if (streamInterval) {
                clearInterval(streamInterval);
                streamInterval = null;
                showMessage('stream-message', '‚èπÔ∏è Stream stopped', 'info');
                document.getElementById('streamData').innerHTML = '';
            }
        }

        // Generate mock stream data
        function generateMockStreamData(device) {
            const baseData = {
                timestamp: new Date().toISOString(),
                deviceId: device.id,
                deviceName: device.name,
                network: 'DIDLab QBFT'
            };

            if (device.type === 'sensor') {
                return {
                    ...baseData,
                    temperature: (18 + Math.random() * 12).toFixed(1) + '¬∞C',
                    humidity: (30 + Math.random() * 40).toFixed(1) + '%',
                    battery: (70 + Math.random() * 30).toFixed(0) + '%',
                    signalStrength: (-80 + Math.random() * 40).toFixed(0) + ' dBm'
                };
            }
            
            return {
                ...baseData,
                status: Math.random() > 0.5 ? 'active' : 'idle',
                signal: (-80 + Math.random() * 40).toFixed(0) + ' dBm',
                battery: (70 + Math.random() * 30).toFixed(0) + '%'
            };
        }

        // Display stream data
        function displayStreamData(data) {
            const html = `
                <div class="device-card">
                    <h4>üì° Live Data Stream <span class="loading">‚óè</span></h4>
                    <p style="color: #10b981; font-weight: 600; margin-bottom: 10px;">Streaming from DIDLab Network</p>
                    ${Object.entries(data).map(([key, value]) => 
                        `<p><strong>${key}:</strong> ${value}</p>`
                    ).join('')}
                </div>
            `;
            document.getElementById('streamData').innerHTML = html;
        }

        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(tab + '-panel').classList.add('active');
        }

        // Show message
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="message ${type}">${message}</div>`;
                setTimeout(() => {
                    element.innerHTML = '';
                }, 8000);
            }
        }

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (streamInterval) clearInterval(streamInterval);
        });
    </script>
</body>
</html>