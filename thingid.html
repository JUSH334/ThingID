<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThingID - IoT Device Identity & Access Management</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .api-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .api-connected {
            background: #d4edda;
            color: #155724;
        }

        .api-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .wallet-status {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .tab {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .panel {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .panel.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
            font-family: monospace;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .btn-danger {
            background: #dc3545;
        }

        .device-card, .access-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            position: relative;
        }

        .device-card h3, .access-card h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .device-info, .access-info {
            color: #666;
            line-height: 1.6;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-expired {
            background: #f8d7da;
            color: #721c24;
        }

        .stream-viewer {
            background: #f1f3f5;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            min-height: 200px;
        }

        .stream-data {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .message {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .revoke-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        .metadata-display {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 14px;
        }

        hr {
            border: none;
            border-top: 1px solid #e0e0e0;
            margin: 30px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê ThingID</h1>
            <p>
                Secure IoT Device Identity & Access Management on Blockchain
                <span id="apiStatus" class="api-status api-disconnected">API: Disconnected</span>
            </p>
        </div>

        <div class="wallet-status">
            <div>
                <strong>Wallet:</strong> <span id="walletAddress">Not connected</span>
            </div>
            <button class="btn" onclick="connectWallet()">Connect Wallet</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('issuer')">üè≠ Issuer</button>
            <button class="tab" onclick="switchTab('owner')">üë§ Device Owner</button>
            <button class="tab" onclick="switchTab('viewer')">üëÅÔ∏è Viewer</button>
        </div>

        <!-- Issuer Panel -->
        <div id="issuer-panel" class="panel active">
            <h2>Issue Device Certificate</h2>
            <div id="issuer-message"></div>
            
            <div class="form-group">
                <label>Device DID</label>
                <input type="text" id="deviceDid" placeholder="did:didlab:device-abc">
            </div>
            
            <div class="form-group">
                <label>Device Public Key</label>
                <input type="text" id="devicePubKey" placeholder="0x04...">
            </div>
            
            <div class="form-group">
                <label>Make</label>
                <input type="text" id="deviceMake" placeholder="SensorCo">
            </div>
            
            <div class="form-group">
                <label>Model</label>
                <input type="text" id="deviceModel" placeholder="S1">
            </div>
            
            <div class="form-group">
                <label>Owner Address</label>
                <input type="text" id="ownerAddress" placeholder="0x...">
            </div>
            
            <div class="form-group">
                <label>Metadata (JSON)</label>
                <textarea id="deviceMetadata" placeholder='{"location": "Building A", "serialNumber": "SN-001"}'></textarea>
            </div>
            
            <button class="btn" onclick="issueDeviceCert()">Issue Device Certificate</button>
        </div>

        <!-- Owner Panel -->
        <div id="owner-panel" class="panel">
            <h2>My Devices & Access Control</h2>
            <div id="owner-message"></div>
            
            <div class="device-list" id="deviceList">
                <p>Loading devices...</p>
            </div>
            
            <hr>
            
            <h3>Grant Access Pass</h3>
            <div class="form-group">
                <label>Select Device</label>
                <select id="deviceSelect">
                    <option value="">Select a device...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Viewer Address</label>
                <input type="text" id="viewerAddress" placeholder="0x...">
            </div>
            
            <div class="form-group">
                <label>Access Duration</label>
                <select id="duration">
                    <option value="3600">1 Hour</option>
                    <option value="86400">1 Day</option>
                    <option value="604800">1 Week</option>
                    <option value="2592000">30 Days</option>
                </select>
            </div>
            
            <button class="btn" onclick="grantAccessPass()">Grant Access Pass</button>
            
            <hr>
            
            <h3>Active Access Passes</h3>
            <div id="accessPassList">
                <p>Loading access passes...</p>
            </div>
        </div>

        <!-- Viewer Panel -->
        <div id="viewer-panel" class="panel">
            <h2>View Device Streams</h2>
            <div id="viewer-message"></div>
            
            <div class="form-group">
                <label>Device DID</label>
                <input type="text" id="viewDeviceDid" placeholder="did:didlab:device-abc">
            </div>
            
            <button class="btn" onclick="checkAccess()">Check Access & View Stream</button>
            
            <div id="streamViewer" class="stream-viewer" style="display: none;">
                <div id="streamContent">
                    <p>Stream content will appear here...</p>
                </div>
            </div>
            
            <hr>
            
            <h3>My Access Passes</h3>
            <div id="myAccessPasses">
                <p>Loading access passes...</p>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:3000/api';
        let currentAccount = null;
        let currentTab = 'issuer';
        let apiConnected = false;
        let streamInterval = null;

        // Check API connection on load
        async function checkAPIConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                if (response.ok) {
                    apiConnected = true;
                    document.getElementById('apiStatus').textContent = 'API: Connected';
                    document.getElementById('apiStatus').className = 'api-status api-connected';
                    return true;
                }
            } catch (error) {
                console.error('API connection failed:', error);
            }
            
            apiConnected = false;
            document.getElementById('apiStatus').textContent = 'API: Disconnected';
            document.getElementById('apiStatus').className = 'api-status api-disconnected';
            return false;
        }

        async function connectWallet() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ 
                        method: 'eth_requestAccounts' 
                    });
                    currentAccount = accounts[0];
                    document.getElementById('walletAddress').textContent = 
                        currentAccount.slice(0, 6) + '...' + currentAccount.slice(-4);
                    
                    refreshUI();
                } catch (error) {
                    alert('Failed to connect wallet: ' + error.message);
                }
            } else {
                // Simulate wallet for demo
                currentAccount = '0x' + Math.random().toString(16).slice(2, 42);
                document.getElementById('walletAddress').textContent = 
                    currentAccount.slice(0, 6) + '...' + currentAccount.slice(-4);
                refreshUI();
            }
        }

        function switchTab(tab) {
            currentTab = tab;
            
            // Clear any running stream intervals
            if (streamInterval) {
                clearInterval(streamInterval);
                streamInterval = null;
            }
            
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => {
                t.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update panels
            document.querySelectorAll('.panel').forEach(p => {
                p.classList.remove('active');
            });
            document.getElementById(tab + '-panel').classList.add('active');
            
            refreshUI();
        }

        async function issueDeviceCert() {
            if (!apiConnected) {
                showMessage('issuer-message', 'API is not connected. Please start the backend server.', 'error');
                return;
            }

            const did = document.getElementById('deviceDid').value;
            const pubKey = document.getElementById('devicePubKey').value;
            const make = document.getElementById('deviceMake').value;
            const model = document.getElementById('deviceModel').value;
            const owner = document.getElementById('ownerAddress').value;
            const metadataStr = document.getElementById('deviceMetadata').value;
            
            if (!did || !pubKey || !make || !model || !owner) {
                showMessage('issuer-message', 'Please fill all required fields', 'error');
                return;
            }
            
            let metadata = {};
            if (metadataStr) {
                try {
                    metadata = JSON.parse(metadataStr);
                } catch (e) {
                    showMessage('issuer-message', 'Invalid JSON in metadata field', 'error');
                    return;
                }
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/devices/issue`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ did, pubKey, make, model, owner, metadata })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('issuer-message', 
                        `‚úÖ Device Certificate issued successfully! Certificate ID: ${data.device.certId}`, 
                        'success');
                    
                    // Clear form
                    document.getElementById('deviceDid').value = '';
                    document.getElementById('devicePubKey').value = '';
                    document.getElementById('deviceMake').value = '';
                    document.getElementById('deviceModel').value = '';
                    document.getElementById('ownerAddress').value = '';
                    document.getElementById('deviceMetadata').value = '';
                    
                    // Important: Refresh ALL panels to update device lists
                    setTimeout(() => {
                        refreshUI();
                    }, 500);
                } else {
                    showMessage('issuer-message', data.error || 'Failed to issue certificate', 'error');
                }
            } catch (error) {
                showMessage('issuer-message', 'Error: ' + error.message, 'error');
            }
        }

        async function grantAccessPass() {
            if (!apiConnected) {
                showMessage('owner-message', 'API is not connected. Please start the backend server.', 'error');
                return;
            }

            const deviceId = document.getElementById('deviceSelect').value;
            const viewer = document.getElementById('viewerAddress').value;
            const duration = document.getElementById('duration').value;
            
            if (!deviceId || !viewer) {
                showMessage('owner-message', 'Please select a device and enter viewer address', 'error');
                return;
            }
            
            if (!currentAccount) {
                showMessage('owner-message', 'Please connect your wallet first', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/access-passes/grant`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        deviceId,
                        viewer,
                        duration,
                        grantedBy: currentAccount
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('owner-message', 
                        `‚úÖ Access Pass granted successfully! Pass ID: ${data.accessPass.passId}`, 
                        'success');
                    
                    document.getElementById('viewerAddress').value = '';
                    
                    // Refresh UI after a short delay to ensure data is updated
                    setTimeout(() => {
                        refreshUI();
                    }, 500);
                } else {
                    showMessage('owner-message', data.error || 'Failed to grant access pass', 'error');
                }
            } catch (error) {
                showMessage('owner-message', 'Error: ' + error.message, 'error');
            }
        }

        async function checkAccess() {
            if (!apiConnected) {
                showMessage('viewer-message', 'API is not connected. Please start the backend server.', 'error');
                return;
            }

            const deviceDid = document.getElementById('viewDeviceDid').value;
            
            if (!deviceDid) {
                showMessage('viewer-message', 'Please enter a Device DID', 'error');
                return;
            }
            
            if (!currentAccount) {
                showMessage('viewer-message', 'Please connect your wallet first', 'error');
                return;
            }
            
            console.log('Checking access for:');
            console.log('Device DID:', deviceDid);
            console.log('Viewer Address:', currentAccount);
            
            try {
                // First, let's check what access passes exist for this viewer
                const passCheckResponse = await fetch(`${API_BASE_URL}/access-passes`);
                const passCheckData = await passCheckResponse.json();
                if (passCheckData.success) {
                    const viewerPasses = passCheckData.accessPasses.filter(p => 
                        p.viewer.toLowerCase() === currentAccount.toLowerCase()
                    );
                    console.log('All passes for this viewer:', viewerPasses);
                    
                    const relevantPass = viewerPasses.find(p => p.deviceDid === deviceDid);
                    if (relevantPass) {
                        console.log('Found relevant pass:', relevantPass);
                        console.log('Pass expired?', relevantPass.expiresAt < Date.now());
                        console.log('Expires at:', new Date(relevantPass.expiresAt).toLocaleString());
                    } else {
                        console.log('No pass found for this device DID');
                    }
                }
                
                const response = await fetch(`${API_BASE_URL}/stream/access`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        deviceDid: deviceDid.trim(),
                        viewerAddress: currentAccount
                    })
                });
                
                const data = await response.json();
                console.log('Access check response:', data);
                
                const streamViewer = document.getElementById('streamViewer');
                streamViewer.style.display = 'block';
                
                if (data.success && data.hasAccess) {
                    showMessage('viewer-message', 
                        `‚úÖ Access granted! Pass valid until ${new Date(data.accessPass.expiresAt).toLocaleString()}`, 
                        'success');
                    
                    // Start streaming data
                    startStreamDisplay(deviceDid);
                } else {
                    showMessage('viewer-message', 
                        `‚ùå Access denied! ${data.error || 'No valid access pass found'}`, 
                        'error');
                    
                    // Show helpful debug info
                    document.getElementById('streamContent').innerHTML = `
                        <div style="text-align: center;">
                            <h3>üîí Access Denied</h3>
                            <p>You don't have permission to view this stream.</p>
                            <p style="margin-top: 20px; font-size: 14px; color: #666;">
                                <strong>Debug Info:</strong><br>
                                Your Address: ${currentAccount}<br>
                                Device DID: ${deviceDid}<br>
                                Check console (F12) for more details
                            </p>
                            <p style="margin-top: 10px;">Please request access from the device owner.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error checking access:', error);
                showMessage('viewer-message', 'Error: ' + error.message, 'error');
            }
        }

        async function startStreamDisplay(deviceDid) {
            // Clear any existing interval
            if (streamInterval) {
                clearInterval(streamInterval);
            }
            
            // Function to fetch and display stream data
            const fetchStreamData = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/stream/${deviceDid}`, {
                        headers: { 
                            'Authorization': `Bearer ${currentAccount}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        displayStreamData(data.streamData, data.device);
                    }
                } catch (error) {
                    console.error('Failed to fetch stream:', error);
                }
            };
            
            // Fetch immediately
            fetchStreamData();
            
            // Then fetch every 3 seconds
            streamInterval = setInterval(fetchStreamData, 3000);
        }

        function displayStreamData(streamData, device) {
            let dataDisplay = '';
            
            // Display data based on what's available
            if (streamData.temperature !== undefined) {
                dataDisplay += `<div>üå°Ô∏è Temperature: ${streamData.temperature}¬∞C</div>`;
            }
            if (streamData.humidity !== undefined) {
                dataDisplay += `<div>üíß Humidity: ${streamData.humidity}%</div>`;
            }
            if (streamData.motion !== undefined) {
                dataDisplay += `<div>üö∂ Motion: ${streamData.motion ? 'DETECTED' : 'None'}</div>`;
                if (streamData.confidence) {
                    dataDisplay += `<div>üìä Confidence: ${streamData.confidence}%</div>`;
                }
            }
            if (streamData.battery) {
                dataDisplay += `<div>üîã Battery: ${streamData.battery}%</div>`;
            }
            if (streamData.signalStrength) {
                dataDisplay += `<div>üì∂ Signal: ${streamData.signalStrength} dBm</div>`;
            }
            
            dataDisplay += `<div>‚è∞ Timestamp: ${streamData.timestamp}</div>`;
            
            document.getElementById('streamContent').innerHTML = `
                <div style="text-align: left; width: 100%;">
                    <h3>üì° Live Stream: ${device.did}</h3>
                    <p><strong>Device:</strong> ${device.make} ${device.model}</p>
                    ${device.metadata && device.metadata.location ? 
                        `<p><strong>Location:</strong> ${device.metadata.location}</p>` : ''}
                    <p><strong>Status:</strong> <span class="status-badge status-active">STREAMING</span></p>
                    <hr style="margin: 20px 0;">
                    <div class="stream-data">
                        ${dataDisplay}
                    </div>
                </div>
            `;
        }

        async function revokeAccessPass(passId) {
            if (!confirm('Are you sure you want to revoke this access pass?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/access-passes/${passId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        revokedBy: currentAccount
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('owner-message', 'Access pass revoked successfully', 'success');
                    refreshUI();
                } else {
                    showMessage('owner-message', data.error || 'Failed to revoke access pass', 'error');
                }
            } catch (error) {
                showMessage('owner-message', 'Error: ' + error.message, 'error');
            }
        }

        async function refreshUI() {
            if (!apiConnected) {
                await checkAPIConnection();
            }
            
            if (currentTab === 'owner') {
                await refreshOwnerPanel();
            } else if (currentTab === 'viewer') {
                await refreshViewerPanel();
            }
        }

        async function refreshOwnerPanel() {
            if (!apiConnected) {
                document.getElementById('deviceList').innerHTML = '<p>API not connected. Please start the backend server.</p>';
                return;
            }
            
            if (!currentAccount) {
                document.getElementById('deviceList').innerHTML = '<p>Please connect your wallet first.</p>';
                return;
            }
            
            try {
                // Fetch ALL devices first to show what's available
                const allDevicesResponse = await fetch(`${API_BASE_URL}/devices`);
                const allDevicesData = await allDevicesResponse.json();
                
                if (allDevicesData.success) {
                    // Filter devices owned by current user (case-insensitive)
                    const allDevices = allDevicesData.devices || [];
                    const myDevices = allDevices.filter(d => 
                        d.owner.toLowerCase() === currentAccount.toLowerCase()
                    );
                    
                    console.log('Current account:', currentAccount);
                    console.log('All devices:', allDevices);
                    console.log('My devices:', myDevices);
                    
                    // Display devices
                    const deviceListHtml = myDevices.length > 0 ? myDevices.map(d => `
                        <div class="device-card">
                            <h3>${d.make} ${d.model}</h3>
                            <div class="device-info">
                                <p><strong>DID:</strong> ${d.did}</p>
                                <p><strong>Certificate:</strong> ${d.certId}</p>
                                <p><strong>Owner:</strong> ${d.owner}</p>
                                <p><strong>Issued:</strong> ${new Date(d.issuedAt).toLocaleDateString()}</p>
                                ${d.metadata && Object.keys(d.metadata).length > 0 ? 
                                    `<div class="metadata-display">
                                        <strong>Metadata:</strong><br>
                                        ${JSON.stringify(d.metadata, null, 2)}
                                    </div>` : ''}
                            </div>
                        </div>
                    `).join('') : `<p>No devices registered for address ${currentAccount}. Issue a device certificate with your address as owner.</p>`;
                    
                    document.getElementById('deviceList').innerHTML = deviceListHtml;
                    
                    // Update device selector
                    const deviceSelect = document.getElementById('deviceSelect');
                    if (myDevices.length > 0) {
                        deviceSelect.innerHTML = '<option value="">Select a device...</option>' +
                            myDevices.map(d => `<option value="${d.id}">${d.make} ${d.model} (${d.did})</option>`).join('');
                    } else {
                        deviceSelect.innerHTML = '<option value="">No devices available</option>';
                    }
                    
                    // Fetch and display access passes for owned devices
                    if (myDevices.length > 0) {
                        const deviceIds = myDevices.map(d => d.id);
                        let allPasses = [];
                        
                        for (const deviceId of deviceIds) {
                            const passesResponse = await fetch(`${API_BASE_URL}/access-passes/device/${deviceId}`);
                            const passesData = await passesResponse.json();
                            if (passesData.success) {
                                allPasses = [...allPasses, ...passesData.accessPasses];
                            }
                        }
                        
                        const passListHtml = allPasses.length > 0 ? allPasses.map(p => {
                            const isExpired = p.expiresAt < Date.now();
                            const device = myDevices.find(d => d.id === p.deviceId);
                            return `
                                <div class="access-card">
                                    ${!isExpired ? `<button class="revoke-btn" onclick="revokeAccessPass('${p.passId}')">Revoke</button>` : ''}
                                    <h3>Pass ${p.passId}</h3>
                                    <div class="access-info">
                                        <p><strong>Device:</strong> ${device ? device.did : 'Unknown'}</p>
                                        <p><strong>Viewer:</strong> ${p.viewer}</p>
                                        <p><strong>Status:</strong> 
                                            <span class="status-badge ${isExpired ? 'status-expired' : 'status-active'}">
                                                ${isExpired ? 'EXPIRED' : 'ACTIVE'}
                                            </span>
                                        </p>
                                        <p><strong>Expires:</strong> ${new Date(p.expiresAt).toLocaleString()}</p>
                                    </div>
                                </div>
                            `;
                        }).join('') : '<p>No access passes granted yet.</p>';
                        
                        document.getElementById('accessPassList').innerHTML = passListHtml;
                    } else {
                        document.getElementById('accessPassList').innerHTML = '<p>No devices to manage access for.</p>';
                    }
                }
            } catch (error) {
                console.error('Failed to refresh owner panel:', error);
                document.getElementById('deviceList').innerHTML = '<p>Error loading devices. Check console for details.</p>';
            }
        }

        async function refreshViewerPanel() {
            if (!apiConnected) {
                document.getElementById('myAccessPasses').innerHTML = '<p>API not connected. Please start the backend server.</p>';
                return;
            }
            
            if (!currentAccount) {
                document.getElementById('myAccessPasses').innerHTML = '<p>Please connect your wallet first.</p>';
                return;
            }
            
            try {
                // Fetch ALL access passes and filter for current viewer
                const allPassesResponse = await fetch(`${API_BASE_URL}/access-passes`);
                const allPassesData = await allPassesResponse.json();
                
                if (allPassesData.success) {
                    const allPasses = allPassesData.accessPasses || [];
                    const myPasses = allPasses.filter(p => 
                        p.viewer.toLowerCase() === currentAccount.toLowerCase()
                    );
                    
                    console.log('Viewer account:', currentAccount);
                    console.log('All passes:', allPasses);
                    console.log('My passes:', myPasses);
                    
                    // Fetch all devices to get device details
                    const devicesResponse = await fetch(`${API_BASE_URL}/devices`);
                    const devicesData = await devicesResponse.json();
                    const devices = devicesData.success ? devicesData.devices : [];
                    
                    const passListHtml = myPasses.length > 0 ? myPasses.map(p => {
                        const isExpired = p.expiresAt < Date.now();
                        const device = devices.find(d => d.id === p.deviceId);
                        
                        return `
                            <div class="access-card">
                                <h3>Pass ${p.passId}</h3>
                                <div class="access-info">
                                    <p><strong>Device:</strong> ${device ? `${device.make} ${device.model}` : 'Unknown'}</p>
                                    <p><strong>DID:</strong> ${p.deviceDid}</p>
                                    <p><strong>Status:</strong> 
                                        <span class="status-badge ${isExpired ? 'status-expired' : 'status-active'}">
                                            ${isExpired ? 'EXPIRED' : 'ACTIVE'}
                                        </span>
                                    </p>
                                    <p><strong>Expires:</strong> ${new Date(p.expiresAt).toLocaleString()}</p>
                                    <p><strong>Granted by:</strong> ${p.grantedBy}</p>
                                </div>
                            </div>
                        `;
                    }).join('') : `<p>No access passes available for address ${currentAccount}.</p>`;
                    
                    document.getElementById('myAccessPasses').innerHTML = passListHtml;
                }
            } catch (error) {
                console.error('Failed to refresh viewer panel:', error);
                document.getElementById('myAccessPasses').innerHTML = '<p>Error loading access passes. Check console for details.</p>';
            }
        }

        function showMessage(elementId, message, type) {
            const messageEl = document.getElementById(elementId);
            messageEl.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                messageEl.innerHTML = '';
            }, 5000);
        }

        // Initialize on load
        window.addEventListener('load', async () => {
            await checkAPIConnection();
            
            // Check API connection every 5 seconds
            setInterval(checkAPIConnection, 5000);
        });
    </script>
</body>
</html>